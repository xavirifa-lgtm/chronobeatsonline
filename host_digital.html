<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOST - CHRONOBEATS DIGITAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Montserrat:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --neon: #00f2ff;
            --bg: #0d0d0d;
            --accent: #ff0055;
            --gold: #ffd700;
        }

        body {
            background: var(--bg);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .logo {
            font-family: 'Bungee';
            font-size: 2em;
            color: var(--neon);
            text-shadow: 0 0 20px var(--neon);
            text-align: center;
            margin-bottom: 20px;
        }

        #lobby {
            text-align: center;
            max-width: 600px;
            margin: auto;
            padding-top: 50px;
        }

        .room-code {
            font-family: 'Bungee';
            font-size: 4em;
            color: var(--gold);
            letter-spacing: 10px;
            margin: 20px 0;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .player-tag {
            background: #222;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #444;
            font-family: 'Bungee';
            font-size: 0.8em;
        }

        #dashboard {
            display: none;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: auto;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .active-player-name {
            font-family: 'Bungee';
            font-size: 1.5em;
            color: var(--neon);
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #111;
            padding: 10px;
            border-radius: 8px;
        }

        .leader-item.active {
            border-left: 4px solid var(--neon);
        }

        /* Reproductor Invisible (Totalmente fuera de la pantalla) */
        #player-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        .validation-area {
            background: #111;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .val-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--neon);
            width: 100%;
            text-align: center;
        }

        .val-card h3 {
            font-family: 'Bungee';
            font-size: 1.5em;
            margin: 10px 0;
        }

        .reveal-btn {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-family: 'Bungee';
            cursor: pointer;
        }

        .actions {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .btn-val {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-family: 'Bungee';
            font-size: 1em;
            cursor: pointer;
        }

        .btn-ok {
            background: #00ff88;
        }

        .btn-fail {
            background: var(--accent);
            color: #fff;
        }

        .timeline-grid {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .player-row {
            background: #161616;
            padding: 10px;
            border-radius: 10px;
        }

        .slots {
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }

        .slot {
            min-width: 45px;
            height: 25px;
            background: #222;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #666;
        }

        .slot.filled {
            background: var(--neon);
            color: #000;
            font-weight: bold;
            border: 1px solid #fff;
        }

        .btn-start {
            background: var(--neon);
            color: #000;
            border: none;
            padding: 20px 60px;
            border-radius: 50px;
            font-family: 'Bungee';
            font-size: 1.4em;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="logo">CHRONOBEATS</div>

    <div id="lobby">
        <div class="room-code" id="join-code">------</div>
        <div class="player-list" id="lobby-players"></div>
        <button class="btn-start" onclick="startGame()" style="display:none;" id="start-btn">EMPEZAR PARTIDA</button>
    </div>

    <div id="dashboard">
        <div class="sidebar">
            <div style="text-align:center; margin-bottom:20px;">
                <p style="font-size: 0.7em; color: #888;">TURNO DE:</p>
                <div class="active-player-name" id="ui-current-player">---</div>
            </div>
            <div id="leaderboard-list"></div>
        </div>
        <div class="main-content">
            <div id="player-container">
                <div id="youtube-player"></div>
            </div>
            <div class="validation-area">
                <div class="val-card" id="val-card-ui" style="display:none;">
                    <p style="font-size: 0.7em; color: var(--neon);">TRACK EN JUEGO</p>
                    <h3 id="ui-card-title">????</h3>
                    <p id="ui-card-info">???? - ????</p>
                    <button class="reveal-btn" id="btn-reveal-host" onclick="revealData()">REVELAR DATOS</button>
                </div>
                <div class="actions" id="validation-buttons" style="display:none;">
                    <button class="btn-val btn-ok" onclick="validateResult(true)">✓ CORRECTO</button>
                    <button class="btn-val btn-fail" onclick="validateResult(false)">✗ ERROR</button>
                </div>
                <div id="host-instructions">ESPERANDO ACCIÓN...</div>
            </div>
            <div class="timeline-grid" id="global-timelines"></div>
        </div>
    </div>

    <script>
        var peer, roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        var players = [], connections = {}, songs = [], currentSongIdx = -1, activePlayerIdx = 0, isRevealed = false;
        var youtubeReady = false, ytPlayer;

        document.getElementById('join-code').innerText = roomCode;

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                host: 'https://www.youtube-nocookie.com',
                height: '0', width: '0',
                playerVars: { 'autoplay': 0, 'controls': 0, 'enablejsapi': 1, 'origin': window.location.origin },
                events: { 'onReady': function () { youtubeReady = true; } }
            });
        }

        function initPeer() {
            peer = new Peer("CB-HOST-" + roomCode);
            peer.on('connection', function (conn) {
                conn.on('data', function (data) {
                    if (data.type === 'JOIN') {
                        players.push({ id: conn.peer, name: data.name, score: 0, cards: [] });
                        connections[conn.peer] = conn;
                        updateLobby();
                    } else if (data.type === 'COMMAND') {
                        handlePlayerCommand(conn.peer, data.action, data.value);
                    }
                });
            });
        }
        setTimeout(initPeer, 500);

        fetch('lista_final.txt').then(function (r) { return r.text() }).then(function (t) {
            songs = t.split('\n').map(function (l) {
                var p = l.split('|');
                var m = p[3] ? p[3].match(/[?&]v=([^&#]+)|youtu\.be\/([^?&#]+)/) : null;
                return { artist: p[0], song: p[1], year: p[2], id: m ? (m[1] || m[2]) : null };
            }).filter(function (s) { return s.id; }).sort(function () { return Math.random() - 0.5; });
        });

        function updateLobby() {
            var h = ""; for (var i = 0; i < players.length; i++) h += '<div class="player-tag">' + players[i].name + '</div>';
            document.getElementById('lobby-players').innerHTML = h;
            if (players.length >= 1) document.getElementById('start-btn').style.display = 'inline-block';
        }

        function startGame() {
            if (!youtubeReady) return alert("Cargando reproductor...");
            ytPlayer.unMute();
            ytPlayer.playVideo(); // Unlocking audio
            setTimeout(function () {
                ytPlayer.stopVideo();
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid';
                nextTurn();
            }, 800);
        }

        function nextTurn() {
            currentSongIdx++; isRevealed = false;
            var s = songs[currentSongIdx];
            document.getElementById('ui-card-title').innerText = "????";
            document.getElementById('ui-card-info').innerText = "???? - ????";
            document.getElementById('btn-reveal-host').style.display = 'block';
            document.getElementById('val-card-ui').style.display = 'block';
            document.getElementById('validation-buttons').style.display = 'none';
            document.getElementById('ui-current-player').innerText = players[activePlayerIdx].name;
            ytPlayer.cueVideoById(s.id);
            syncState();
        }

        function handlePlayerCommand(peerId, action, value) {
            if (peerId !== players[activePlayerIdx].id) return;
            switch (action) {
                case 'PLAY': ytPlayer.unMute(); ytPlayer.playVideo(); break;
                case 'PAUSE': ytPlayer.pauseVideo(); break;
                case 'STOP':
                    ytPlayer.stopVideo();
                    document.getElementById('host-instructions').innerText = "¿ACERTÓ?";
                    revealData();
                    break;
                case 'SKIP': ytPlayer.seekTo(ytPlayer.getCurrentTime() + value, true); break;
            }
        }

        function revealData() {
            isRevealed = true;
            var s = songs[currentSongIdx];
            document.getElementById('ui-card-title').innerText = s.song;
            document.getElementById('ui-card-info').innerText = s.artist + " - " + s.year;
            document.getElementById('btn-reveal-host').style.display = 'none';
            document.getElementById('validation-buttons').style.display = 'flex';
            syncState();
        }

        function validateResult(isOk) {
            if (isOk) {
                players[activePlayerIdx].score++;
                players[activePlayerIdx].cards.push(songs[currentSongIdx].year);
                players[activePlayerIdx].cards.sort();
            }
            activePlayerIdx = (activePlayerIdx + 1) % players.length;
            nextTurn();
        }

        function syncState() {
            var state = { type: 'STATE_UPDATE', activePlayer: { id: players[activePlayerIdx].id, name: players[activePlayerIdx].name }, currentTrack: songs[currentSongIdx], revealed: isRevealed };
            for (var id in connections) connections[id].send(state);
            updateUI();
        }

        function updateUI() {
            var h = ""; players.slice().sort(function (a, b) { return b.score - a.score }).forEach(function (p) {
                h += '<div class="leader-item ' + (p.id === players[activePlayerIdx].id ? 'active' : '') + '"><span>' + p.name + '</span><span class="score">' + p.score + ' p</span></div>';
            });
            document.getElementById('leaderboard-list').innerHTML = h;
            var timelinesHtml = ""; players.forEach(function (p) {
                timelinesHtml += '<div class="player-row"><div style="font-size:0.6em;color:#888;">' + p.name + '</div><div class="slots">';
                for (var k = 0; k < 10; k++) timelinesHtml += '<div class="slot ' + (p.cards[k] ? 'filled' : '') + '">' + (p.cards[k] || '') + '</div>';
                timelinesHtml += '</div></div>';
            });
            document.getElementById('global-timelines').innerHTML = timelinesHtml;
        }
    </script>
</body>

</html>