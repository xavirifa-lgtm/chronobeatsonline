<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOST - CHRONOBEATS DIGITAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Montserrat:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- Eliminado script de YouTube API ya que usamos inyección de iframe directa -->
    <style>
        :root {
            --neon: #00f2ff;
            --bg: #0d0d0d;
            --accent: #ff0055;
            --gold: #ffd700;
        }

        body {
            background: var(--bg);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .logo {
            font-family: 'Bungee';
            font-size: 2em;
            color: var(--neon);
            text-shadow: 0 0 20px var(--neon);
            text-align: center;
            margin-bottom: 20px;
        }

        #lobby {
            text-align: center;
            max-width: 600px;
            margin: auto;
            padding-top: 50px;
        }

        .room-code {
            font-family: 'Bungee';
            font-size: 4em;
            color: var(--gold);
            letter-spacing: 10px;
            margin: 20px 0;
        }

        .music-controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            width: 100%;
            max-width: 320px;
            margin-top: 10px;
        }

        .skip-controls {
            display: none;
            grid-template-rows: repeat(2, 1fr);
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            width: 100%;
            max-width: 320px;
            margin-top: 5px;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .player-tag {
            background: #222;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #444;
            font-family: 'Bungee';
            font-size: 0.8em;
        }

        #dashboard {
            display: none;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: auto;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .active-player-name {
            font-family: 'Bungee';
            font-size: 1.5em;
            color: var(--neon);
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #111;
            padding: 10px;
            border-radius: 8px;
        }

        .leader-item.active {
            border-left: 4px solid var(--neon);
        }

        /* Reproductor Totalmente fuera de la pantalla */
        #player-container {
            position: absolute;
            top: -999px;
            left: -999px;
            visibility: hidden;
        }

        #player-container iframe {
            width: 1px;
            height: 1px;
            border: none;
        }

        .validation-area {
            background: #111;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .val-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--neon);
            width: 100%;
            text-align: center;
        }

        .val-card h3 {
            font-family: 'Bungee';
            font-size: 1.5em;
            margin: 10px 0;
        }

        .reveal-btn {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-family: 'Bungee';
            cursor: pointer;
        }

        .actions {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .btn-val {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-family: 'Bungee';
            font-size: 1em;
            cursor: pointer;
        }

        .btn-ok {
            background: #00ff88;
        }

        .btn-fail {
            background: var(--accent);
            color: #fff;
        }

        .timeline-grid {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .player-row {
            background: #161616;
            padding: 10px;
            border-radius: 10px;
        }

        .slots {
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }

        .slot {
            min-width: 45px;
            height: 25px;
            background: #222;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #666;
        }

        .slot.filled {
            background: var(--neon);
            color: #000;
            font-weight: bold;
            border: 1px solid #fff;
        }

        .btn-start {
            background: var(--neon);
            color: #000;
            border: none;
            padding: 20px 60px;
            border-radius: 50px;
            font-family: 'Bungee';
            font-size: 1.4em;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="logo">CHRONOBEATS</div>

    <div id="lobby">
        <div class="room-code" id="join-code">------</div>
        <div class="player-list" id="lobby-players"></div>
        <button class="btn-start" onclick="startGame()" style="display:none;" id="start-btn">EMPEZAR PARTIDA</button>
    </div>

    <div id="dashboard">
        <div class="sidebar">
            <div style="text-align:center; margin-bottom:20px;">
                <p style="font-size: 0.7em; color: #888;">TURNO DE:</p>
                <div class="active-player-name" id="ui-current-player">---</div>
            </div>
            <div id="leaderboard-list"></div>
        </div>
        <div class="main-content">
            <div id="player-container">
                <div id="youtube-player"></div>
            </div>
            <div class="validation-area">
                <div class="val-card" id="val-card-ui" style="display:none;">
                    <p style="font-size: 0.7em; color: var(--neon); margin-bottom: 5px;">CANCIÓN EN JUEGO</p>
                    <p id="ui-card-artist" style="font-size: 0.9em; color: #aaa; margin: 0; font-weight: bold;">????</p>
                    <h3 id="ui-card-song" style="margin: 5px 0; font-size: 1.2em;">????</h3>
                    <div id="ui-card-year"
                        style="font-family: 'Bungee'; font-size: 3.5em; color: var(--accent); margin-top: 5px; line-height: 1;">
                        ????</div>
                    <button class="reveal-btn" id="btn-reveal-host" onclick="revealData()"
                        style="display:block; margin: 15px auto;">REVELAR DATOS</button>
                    <div class="actions" id="validation-buttons"
                        style="display:none; gap: 10px; width: 100%; margin-top: 15px;">
                        <button class="btn-val btn-ok" onclick="validateResult(true)">ACERTÓ</button>
                        <button class="btn-val btn-fail" onclick="validateResult(false)">FALLÓ</button>
                    </div>
                </div>
                <div id="host-instructions">ESPERANDO ACCIÓN...</div>
            </div>
        </div>
        <div class="timeline-grid" id="global-timelines"></div>
    </div>
    </div>

    <script>
        var peer, roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        var players = [], connections = {}, songs = [], currentSongIdx = -1, activePlayerIdx = 0, isRevealed = false;

        // Seguimiento de tiempo para skips manuales
        var segundosAcumulados = 0;
        var momentoDeInicio = 0;
        var isPlaying = false;

        document.getElementById('join-code').innerText = roomCode;

        // Eliminadas funciones de YT API

        function initPeer() {
            peer = new Peer("CB-HOST-" + roomCode);
            peer.on('open', function (id) {
                console.log("Host Peer Abierto:", id);
            });
            peer.on('connection', function (conn) {
                console.log("Nueva conexión entrante:", conn.peer);
                conn.on('open', function () {
                    console.log("Conexión con el player abierta");
                });
                conn.on('data', function (data) {
                    console.log("Comando recibido en host:", data);
                    if (data.type === 'JOIN') {
                        // PROTECCIÓN DUPLICADOS: Buscar si el nombre ya existe
                        var existing = players.find(function (p) { return p.name === data.name; });
                        if (existing) {
                            console.log("Reconexión de jugador:", data.name);
                            existing.id = conn.peer;
                        } else {
                            players.push({ id: conn.peer, name: data.name, score: 0, cards: [] });
                        }
                        connections[conn.peer] = conn;
                        updateLobby();
                    } else if (data.type === 'COMMAND') {
                        handlePlayerCommand(conn.peer, data.action, data.value);
                    }
                });
                conn.on('error', function (err) {
                    console.error("Error en conexión:", err);
                });
            });
            peer.on('error', function (err) {
                if (err.type === 'unavailable-id') {
                    alert("El ID de sala ya existe o hay un error. Probando uno nuevo...");
                    window.location.reload();
                } else {
                    alert("Error PeerJS Host: " + err.type);
                }
            });
        }
        initPeer();

        fetch('lista_final.txt').then(function (r) { return r.text() }).then(function (t) {
            songs = t.split('\n').map(function (l) {
                var p = l.split('|');
                var m = p[3] ? p[3].match(/[?&]v=([^&#]+)|youtu\.be\/([^?&#]+)/) : null;
                return { artist: p[0], song: p[1], year: p[2], id: m ? (m[1] || m[2]) : null };
            }).filter(function (s) { return s.id; }).sort(function () { return Math.random() - 0.5; });
        });

        function updateLobby() {
            var h = ""; for (var i = 0; i < players.length; i++) h += '<div class="player-tag">' + players[i].name + '</div>';
            document.getElementById('lobby-players').innerHTML = h;
            if (players.length >= 1) document.getElementById('start-btn').style.display = 'inline-block';
        }

        function startGame() {

            // MECÁNICA INICIAL: Repartir una carta a cada jugador
            players.forEach(function (p) {
                currentSongIdx++;
                var s = songs[currentSongIdx];
                if (s) p.cards.push(s.year);
            });

            document.getElementById('lobby').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';
            nextTurn();
        }

        function nextTurn() {
            currentSongIdx++; isRevealed = false;
            segundosAcumulados = 0; // Reset tiempo para nueva canción
            momentoDeInicio = 0;
            isPlaying = false;
            var s = songs[currentSongIdx];
            document.getElementById('ui-card-artist').innerText = "????";
            document.getElementById('ui-card-song').innerText = "????";
            document.getElementById('ui-card-year').innerText = "????";
            document.getElementById('btn-reveal-host').style.display = 'block';
            document.getElementById('val-card-ui').style.display = 'block';
            document.getElementById('validation-buttons').style.display = 'none';
            document.getElementById('ui-current-player').innerText = players[activePlayerIdx].name;
            document.getElementById('host-instructions').innerText = "ESPERANDO ACCIÓN...";
            syncState();
        }

        function handlePlayerCommand(peerId, action, value) {
            if (peerId !== players[activePlayerIdx].id) return;
            var s = songs[currentSongIdx];
            var container = document.getElementById('player-container');

            switch (action) {
                case 'PLAY':
                    if (!isPlaying) {
                        momentoDeInicio = Date.now();
                        isPlaying = true;
                        container.innerHTML = '<iframe src="https://www.youtube-nocookie.com/embed/' + s.id + '?autoplay=1&start=' + segundosAcumulados + '" allow="autoplay"></iframe>';
                        document.getElementById('host-instructions').innerText = "REPRODUCIENDO";
                    }
                    break;
                case 'PAUSE':
                    if (isPlaying) {
                        var tiempoTranscurrido = Math.floor((Date.now() - momentoDeInicio) / 1000);
                        segundosAcumulados += tiempoTranscurrido;
                        container.innerHTML = '';
                        isPlaying = false;
                        document.getElementById('host-instructions').innerText = "PAUSADO";
                    }
                    break;
                case 'STOP':
                    isPlaying = false;
                    container.innerHTML = '';
                    document.getElementById('host-instructions').innerText = "¿ACERTÓ?";
                    revealData();
                    break;
                case 'SKIP':
                    if (isPlaying) {
                        var tiempoTranscurrido = Math.floor((Date.now() - momentoDeInicio) / 1000);
                        segundosAcumulados += tiempoTranscurrido + value;
                    } else {
                        segundosAcumulados += value;
                    }
                    if (segundosAcumulados < 0) segundosAcumulados = 0;
                    momentoDeInicio = Date.now();
                    if (isPlaying) {
                        container.innerHTML = '<iframe src="https://www.youtube-nocookie.com/embed/' + s.id + '?autoplay=1&start=' + segundosAcumulados + '" allow="autoplay"></iframe>';
                        document.getElementById('host-instructions').innerText = "REPRODUCIENDO";
                    }
                    break;
            }
        }

        function revealData() {
            isRevealed = true;
            var s = songs[currentSongIdx];
            document.getElementById('ui-card-artist').innerText = s.artist;
            document.getElementById('ui-card-song').innerText = s.song;
            document.getElementById('ui-card-year').innerText = s.year;
            document.getElementById('btn-reveal-host').style.display = 'none';
            document.getElementById('validation-buttons').style.display = 'flex';
            syncState();
        }

        function validateResult(isOk) {
            if (isOk) {
                players[activePlayerIdx].score++;
                players[activePlayerIdx].cards.push(songs[currentSongIdx].year);
                players[activePlayerIdx].cards.sort();
            }
            activePlayerIdx = (activePlayerIdx + 1) % players.length;
            nextTurn();
        }

        function syncState() {
            var state = { type: 'STATE_UPDATE', activePlayer: { id: players[activePlayerIdx].id, name: players[activePlayerIdx].name }, currentTrack: songs[currentSongIdx], revealed: isRevealed };
            for (var id in connections) connections[id].send(state);
            updateUI();
        }

        function updateUI() {
            var h = ""; players.slice().sort(function (a, b) { return b.score - a.score }).forEach(function (p) {
                h += '<div class="leader-item ' + (p.id === players[activePlayerIdx].id ? 'active' : '') + '"><span>' + p.name + '</span><span class="score">' + p.score + ' p</span></div>';
            });
            document.getElementById('leaderboard-list').innerHTML = h;
            var timelinesHtml = ""; players.forEach(function (p) {
                timelinesHtml += '<div class="player-row"><div style="font-size:0.6em;color:#888;">' + p.name + '</div><div class="slots">';
                for (var k = 0; k < 10; k++) timelinesHtml += '<div class="slot ' + (p.cards[k] ? 'filled' : '') + '">' + (p.cards[k] || '') + '</div>';
                timelinesHtml += '</div></div>';
            });
            document.getElementById('global-timelines').innerHTML = timelinesHtml;
        }
    </script>
</body>

</html>